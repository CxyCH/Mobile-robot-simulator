<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">predvec</span>, <span class="var type1" id="S3T1U4">cgridvecprev</span>, <span class="var type1" id="S4T2U5">context</span>, <span class="var type1" id="S5T1U6">maxvec</span>] <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line">    <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line">    = occflow( <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line">      <span class="var type1" id="S6T1U9">cgridvec</span>, <span class="var type1" id="S3T1U10">cgridvecprev</span>, <span class="var type1" id="S4T2U11">context</span> <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line">    , <span class="var type1" id="S7T2U12">nei_idx</span>, <span class="var type1" id="S8T2U13">nei_weight</span>, <span class="var type1" id="S9T3U14">nei_filter_n</span> <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line">    , <span class="var type1" id="S10T2U15">nei4u_idx</span>, <span class="var type1" id="S11T2U16">nei4u_weight</span>, <span class="var type1" id="S12T3U17">nei4u_filter_n</span> <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line">    , <span class="var type1" id="S13T3U18">occval</span> , <span class="var type1" id="S14T3U19">minthreshold</span>, <span class="var type1" id="S15T3U20">maxthreshold</span>, <span class="var type1" id="S16T3U21">reinitval</span> <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line">    , <span class="var type1" id="S17T3U22">intensifyrate</span>, <span class="var type1" id="S18T3U23">nocc_attenuaterate</span>, <span class="var type1" id="S19T3U24">unknown_attenuaterate</span>, <span class="var type1" id="S20T3U25">sigm_coef</span> <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line">    , <span class="var type1" id="S21T3U26">do_attenuation_first</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">% Occupancy flow with vector input </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">% Compute indices first </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="mxinfo " id="T1:U23"><span class="var type1" id="S22T1U29">newlyoccidx</span>  = <span class="mxinfo " id="T1:U25">find(<span class="mxinfo " id="T4:U26"><span class="mxinfo " id="T4:U27"><span class="var type1" id="S6T1U34">cgridvec</span> == <span class="var type1" id="S13T3U35">occval</span></span> &amp; <span class="mxinfo " id="T4:U30"><span class="var type1" id="S3T1U37">cgridvecprev</span> ~= <span class="var type1" id="S13T3U38">occval</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="mxinfo " id="T3:U33"><span class="var type1" id="S24T3U41">nrnewlyocc</span>   = <span class="mxinfo " id="T3:U35">length(<span class="var type1" id="S22T1U44">newlyoccidx</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="mxinfo " id="T1:U37"><span class="var type1" id="S26T1U47">occidx</span>       = <span class="mxinfo " id="T1:U39">find(<span class="mxinfo " id="T4:U40"><span class="var type1" id="S6T1U51">cgridvec</span> == <span class="var type1" id="S13T3U52">occval</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="mxinfo " id="T3:U43"><span class="var type1" id="S27T3U55">nrocc</span>        = <span class="mxinfo " id="T3:U45">length(<span class="var type1" id="S26T1U58">occidx</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="mxinfo " id="T1:U47"><span class="var type1" id="S28T1U61">noccidx</span>      = <span class="mxinfo " id="T1:U49">find(<span class="mxinfo " id="T4:U50"><span class="var type1" id="S6T1U65">cgridvec</span> ~= <span class="var type1" id="S13T3U66">occval</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="mxinfo " id="T3:U53"><span class="var type1" id="S29T3U69">nrnocc</span>       = <span class="mxinfo " id="T3:U55">length(<span class="var type1" id="S28T1U72">noccidx</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">% 1 Intensify newly occupied cells </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S30T3U75">j</span> = <span class="mxinfo " id="T3:U58">1</span>:<span class="var type1" id="S24T3U78">nrnewlyocc</span> <span class="comment">% For newly occupied cells </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line">    <span class="mxinfo " id="T3:U60"><span class="var type1" id="S31T3U81">coccidx</span> = <span class="mxinfo " id="T3:U62"><span class="var type1" id="S22T1U83">newlyoccidx</span>(<span class="var type1" id="S30T3U84">j</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line">    <span class="mxinfo " id="T5:U65"><span class="var type1" id="S32T5U87">curr_col</span> = <span class="mxinfo " id="T5:U67"><span class="var type1" id="S4T2U89">context</span>(<span class="var type1" id="S31T3U90">coccidx</span>, <span class="mxinfo " id="T6:U70">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T7:U71"><span class="mxinfo " id="T3:U72">max(<span class="var type1" id="S32T5U97">curr_col</span>)</span> &lt; <span class="var type1" id="S14T3U98">minthreshold</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line">        <span class="mxinfo " id="T5:U75"><span class="mxinfo " id="T5:U76"><span class="var type1" id="S4T2U102">context</span>(<span class="var type1" id="S31T3U103">coccidx</span>, <span class="mxinfo " id="T6:U79">:</span>)</span> = <span class="var type1" id="S16T3U105">reinitval</span></span>;        <span class="comment">% Reinitialize</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line">        <span class="mxinfo " id="T5:U81"><span class="var type1" id="S34T5U109">updt_col</span> = <span class="mxinfo " id="T5:U83"><span class="var type1" id="S17T3U111">intensifyrate</span>*<span class="var type1" id="S32T5U112">curr_col</span></span></span>;      <span class="comment">% Intensify</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line">        <span class="mxinfo " id="T5:U86"><span class="var type1" id="S34T5U115">updt_col</span> = <span class="mxinfo " id="T5:U88">min(<span class="var type1" id="S34T5U118">updt_col</span>, <span class="var type1" id="S15T3U119">maxthreshold</span>)</span></span>; <span class="comment">% Max-thesholding</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line">        <span class="mxinfo " id="T5:U91"><span class="mxinfo " id="T5:U92"><span class="var type1" id="S4T2U123">context</span>(<span class="var type1" id="S31T3U124">coccidx</span>, <span class="mxinfo " id="T6:U95">:</span>)</span> = <span class="var type1" id="S34T5U126">updt_col</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"><span class="comment">% 2 Attenuate unoccupied cells</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T7:U97"><span class="var type1" id="S21T3U130">do_attenuation_first</span> == <span class="mxinfo " id="T3:U99">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S30T3U134">j</span> = <span class="mxinfo " id="T3:U101">1</span>:<span class="var type1" id="S29T3U137">nrnocc</span> <span class="comment">% For unoccupied cells</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">        <span class="mxinfo " id="T3:U103"><span class="var type1" id="S36T3U140">cnoccidx</span> = <span class="mxinfo " id="T3:U105"><span class="var type1" id="S28T1U142">noccidx</span>(<span class="var type1" id="S30T3U143">j</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">        <span class="mxinfo " id="T5:U108"><span class="var type1" id="S32T5U146">curr_col</span> = <span class="mxinfo " id="T5:U110"><span class="var type1" id="S4T2U148">context</span>(<span class="var type1" id="S36T3U149">cnoccidx</span>, <span class="mxinfo " id="T6:U113">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">        <span class="mxinfo " id="T5:U114"><span class="var type1" id="S34T5U153">updt_col</span> = <span class="mxinfo " id="T5:U116"><span class="var type1" id="S32T5U155">curr_col</span>*<span class="var type1" id="S18T3U156">nocc_attenuaterate</span></span></span>;  <span class="comment">% Attenuate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line">        <span class="mxinfo " id="T5:U119"><span class="mxinfo " id="T5:U120"><span class="var type1" id="S4T2U160">context</span>(<span class="var type1" id="S36T3U161">cnoccidx</span>, <span class="mxinfo " id="T6:U123">:</span>)</span> = <span class="var type1" id="S34T5U163">updt_col</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="comment">% 4 Propagation </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S30T3U166">j</span> = <span class="mxinfo " id="T3:U126">1</span>:<span class="var type1" id="S27T3U169">nrocc</span> <span class="comment">% For occupied cells </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line">    <span class="mxinfo " id="T3:U128"><span class="var type1" id="S37T3U172">cpropidx</span>   = <span class="mxinfo " id="T3:U130"><span class="var type1" id="S26T1U174">occidx</span>(<span class="var type1" id="S30T3U175">j</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line">    <span class="mxinfo " id="T5:U133"><span class="var type1" id="S32T5U178">curr_col</span>   = <span class="mxinfo " id="T5:U135"><span class="var type1" id="S4T2U180">context</span>(<span class="var type1" id="S37T3U181">cpropidx</span>, <span class="mxinfo " id="T6:U138">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">    <span class="mxinfo " id="T5:U139"><span class="var type1" id="S38T5U185">cneicon</span>    = <span class="mxinfo " id="T5:U141"><span class="var type1" id="S7T2U187">nei_idx</span>(<span class="var type1" id="S37T3U188">cpropidx</span>, <span class="mxinfo " id="T6:U144">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line">    <span class="mxinfo " id="T5:U145"><span class="var type1" id="S39T5U192">cneiweight</span> = <span class="mxinfo " id="T5:U147"><span class="var type1" id="S8T2U194">nei_weight</span>(<span class="var type1" id="S37T3U195">cpropidx</span>, <span class="mxinfo " id="T6:U150">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S40T3U199">k</span> = <span class="mxinfo " id="T3:U152">1</span>:<span class="var type1" id="S9T3U202">nei_filter_n</span> <span class="comment">% For all neighbor cells </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">        <span class="mxinfo " id="T3:U154"><span class="var type1" id="S41T3U205">contextval</span> = <span class="mxinfo " id="T3:U156"><span class="var type1" id="S32T5U207">curr_col</span>(<span class="var type1" id="S40T3U208">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">        <span class="mxinfo " id="T3:U159"><span class="var type1" id="S42T3U211">neiidx</span>     = <span class="mxinfo " id="T3:U161"><span class="var type1" id="S38T5U213">cneicon</span>(<span class="var type1" id="S40T3U214">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">        <span class="mxinfo " id="T3:U164"><span class="var type1" id="S43T3U217">weightval</span>  = <span class="mxinfo " id="T3:U166"><span class="var type1" id="S39T5U219">cneiweight</span>(<span class="var type1" id="S40T3U220">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T7:U169"><span class="var type1" id="S42T3U224">neiidx</span> ~= <span class="mxinfo " id="T3:U171">0</span></span> <span class="comment">% If properly connected, propagate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line">            <span class="mxinfo " id="T3:U172"><span class="var type1" id="S44T3U228">origvontextval</span> = <span class="mxinfo " id="T3:U174"><span class="var type1" id="S4T2U230">context</span>(<span class="var type1" id="S42T3U231">neiidx</span>, <span class="var type1" id="S40T3U232">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line">            <span class="mxinfo " id="T3:U178"><span class="var type1" id="S45T3U235">updtcontextval</span> = <span class="mxinfo " id="T3:U180"><span class="var type1" id="S43T3U237">weightval</span>*<span class="var type1" id="S41T3U238">contextval</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">            <span class="mxinfo " id="T3:U183"><span class="var type1" id="S45T3U241">updtcontextval</span> = <span class="mxinfo " id="T3:U185">min(<span class="var type1" id="S45T3U244">updtcontextval</span>, <span class="var type1" id="S15T3U245">maxthreshold</span>)</span></span>; <span class="comment">% Maximum value thresholding </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line">            <span class="mxinfo " id="T3:U188"><span class="mxinfo " id="T3:U189"><span class="var type1" id="S4T2U249">context</span>(<span class="var type1" id="S42T3U250">neiidx</span>, <span class="var type1" id="S40T3U251">k</span>)</span> = <span class="mxinfo " id="T3:U193">max(<span class="var type1" id="S44T3U254">origvontextval</span>, <span class="var type1" id="S45T3U255">updtcontextval</span>)</span></span>; <span class="comment">% Make sure current context propagation does not weaken the flow information</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"><span class="comment">% 5 Uncertainty in acceleration</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="mxinfo " id="T2:U196"><span class="var type1" id="S46T2U258">tempcontext</span> = <span class="var type1" id="S4T2U259">context</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S30T3U262">j</span> = <span class="mxinfo " id="T3:U200">1</span>:<span class="var type1" id="S9T3U265">nei_filter_n</span> <span class="comment">% For all context level</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S40T3U268">k</span> = <span class="mxinfo " id="T3:U203">1</span>:<span class="mxinfo " id="T3:U204">size(<span class="var type1" id="S7T2U273">nei_idx</span>, 1)</span> <span class="comment">% For all cells</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">        <span class="mxinfo " id="T3:U206"><span class="var type1" id="S48T3U277">sumval</span> = <span class="mxinfo " id="T3:U208">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S49T3U281">m</span> = <span class="mxinfo " id="T3:U210">1</span>:<span class="var type1" id="S12T3U284">nei4u_filter_n</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">            <span class="mxinfo " id="T3:U212"><span class="var type1" id="S50T3U287">nidx</span> = <span class="mxinfo " id="T3:U214"><span class="var type1" id="S10T2U289">nei4u_idx</span>(<span class="var type1" id="S40T3U290">k</span>, <span class="var type1" id="S49T3U291">m</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">            <span class="mxinfo " id="T3:U218"><span class="var type1" id="S51T3U294">nwei</span> = <span class="mxinfo " id="T3:U220"><span class="mxinfo " id="T3:U221"><span class="var type1" id="S11T2U297">nei4u_weight</span>(<span class="var type1" id="S40T3U298">k</span>, <span class="var type1" id="S49T3U299">m</span>)</span>/<span class="mxinfo " id="T3:U225">sum(<span class="mxinfo " id="T5:U226"><span class="var type1" id="S11T2U303">nei4u_weight</span>(<span class="var type1" id="S40T3U304">k</span>, <span class="mxinfo " id="T6:U229">:</span>)</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo " id="T7:U230"><span class="var type1" id="S50T3U309">nidx</span> ~= <span class="mxinfo " id="T3:U232">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">                <span class="mxinfo " id="T3:U233"><span class="var type1" id="S53T3U313">curr_val</span> = <span class="mxinfo " id="T3:U235"><span class="var type1" id="S4T2U315">context</span>(<span class="var type1" id="S50T3U316">nidx</span>, <span class="var type1" id="S30T3U317">j</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">                <span class="mxinfo " id="T3:U239"><span class="var type1" id="S48T3U320">sumval</span>   = <span class="mxinfo " id="T3:U241"><span class="var type1" id="S48T3U322">sumval</span> + <span class="mxinfo " id="T3:U243"><span class="var type1" id="S51T3U324">nwei</span>*<span class="var type1" id="S53T3U325">curr_val</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">        <span class="mxinfo " id="T3:U246"><span class="mxinfo " id="T3:U247"><span class="var type1" id="S46T2U329">tempcontext</span>(<span class="var type1" id="S40T3U330">k</span>, <span class="var type1" id="S30T3U331">j</span>)</span> = <span class="var type1" id="S48T3U332">sumval</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line"><span class="mxinfo " id="T2:U252"><span class="var type1" id="S4T2U335">context</span> = <span class="var type1" id="S46T2U336">tempcontext</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T7:U255"><span class="var type1" id="S21T3U340">do_attenuation_first</span> == <span class="mxinfo " id="T3:U257">0</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">    <span class="comment">% 2 Attenuate unoccupied cells</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S30T3U344">j</span> = <span class="mxinfo " id="T3:U259">1</span>:<span class="var type1" id="S29T3U347">nrnocc</span> <span class="comment">% For unoccupied cells, attenuate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">        <span class="mxinfo " id="T3:U261"><span class="var type1" id="S36T3U350">cnoccidx</span> = <span class="mxinfo " id="T3:U263"><span class="var type1" id="S28T1U352">noccidx</span>(<span class="var type1" id="S30T3U353">j</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">        <span class="mxinfo " id="T5:U266"><span class="var type1" id="S32T5U356">curr_col</span> = <span class="mxinfo " id="T5:U268"><span class="var type1" id="S4T2U358">context</span>(<span class="var type1" id="S36T3U359">cnoccidx</span>, <span class="mxinfo " id="T6:U271">:</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">        <span class="mxinfo " id="T5:U272"><span class="var type1" id="S34T5U363">updt_col</span> = <span class="mxinfo " id="T5:U274"><span class="var type1" id="S32T5U365">curr_col</span>*<span class="var type1" id="S18T3U366">nocc_attenuaterate</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">        <span class="mxinfo " id="T5:U277"><span class="mxinfo " id="T5:U278"><span class="var type1" id="S4T2U370">context</span>(<span class="var type1" id="S36T3U371">cnoccidx</span>, <span class="mxinfo " id="T6:U281">:</span>)</span> = <span class="var type1" id="S34T5U373">updt_col</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line"><span class="comment">% 6 Prediction</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"><span class="mxinfo " id="T1:U283"><span class="var type1" id="S5T1U376">maxvec</span>  = <span class="mxinfo " id="T1:U285"><span class="mxinfo " id="T5:U286">max(<span class="mxinfo " id="T2:U287"><span class="var type1" id="S4T2U381">context</span>'</span>)</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line"><span class="mxinfo " id="T1:U289"><span class="var type1" id="S2T1U384">predvec</span> = <span class="mxinfo " id="T1:U291"><span class="fcn" id="F141N4:B386">sigm</span>(<span class="var type1" id="S5T1U387">maxvec</span>, <span class="var type1" id="S20T3U388">sigm_coef</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line"><span class="comment">% 7 Save previous grid</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line"><span class="mxinfo " id="T1:U294"><span class="var type1" id="S3T1U391">cgridvecprev</span> = <span class="var type1" id="S6T1U392">cgridvec</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"></span></span>
</pre>
